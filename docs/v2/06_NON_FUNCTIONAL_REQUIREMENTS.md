# Vibe Pay 개발 사양서: 6. 비기능 요구사항

이 문서는 Vibe Pay 시스템의 비기능 요구사항을 정의한다. 이는 시스템의 품질 속성(Quality Attributes)을 명시하며, 기능적 요구사항 외에 시스템이 갖춰야 할 특성들을 설명한다.

## 1. 성능 목표

-   **응답 시간**: 핵심 결제 API (`/api/payments/initiate`, `/api/orders`)는 평균 200ms 이내, 최대 500ms 이내로 응답해야 한다.
-   **처리량 (TPS)**: 초당 최소 100건 이상의 결제 요청을 처리할 수 있어야 한다.
-   **확장성**: 트래픽 증가에 따라 서버 인스턴스를 수평 확장하여 처리량을 선형적으로 증가시킬 수 있는 아키텍처를 갖춰야 한다.
-   **PG 연동 지연**: 외부 PG사 API 호출로 인한 지연은 백엔드 시스템의 전체 응답 시간에 영향을 미치지 않도록 비동기(WebFlux) 방식으로 처리한다.

## 2. 보안 요구사항

-   **민감 정보 보호**: PG사 연동 키, 데이터베이스 비밀번호 등 모든 민감 정보는 환경변수를 통해 관리되며, 소스 코드에 직접 노출되지 않아야 한다.
-   **데이터 암호화**: 전송 중인 데이터(In-transit)는 HTTPS를 통해 암호화되어야 한다. 저장된 데이터(At-rest) 중 민감한 정보(예: 사용자 개인 정보)는 암호화하여 저장하는 것을 고려해야 한다.
-   **API 보안**: 모든 API는 적절한 인증 및 인가 메커니즘(현재는 외부 시스템에 위임)을 통해 보호되어야 하며, 무단 접근을 방지해야 한다.
-   **입력값 검증**: 모든 사용자 입력 및 외부 시스템으로부터의 입력값은 SQL Injection, XSS 등 보안 취약점을 방지하기 위해 철저히 검증되어야 한다.
-   **거래 위변조 방지**: PG사 연동 시 `signature` 또는 `SignData`와 같은 해시 값을 사용하여 거래 요청의 무결성을 검증한다.

## 3. 로깅 및 모니터링 전략

-   **로깅 수준**: 개발 환경에서는 `DEBUG` 수준, 운영 환경에서는 `INFO` 또는 `WARN` 수준으로 로깅을 설정한다.
-   **로그 형식**: `application.yml`에 정의된 표준 로그 형식을 사용하며, 시간, 로그 레벨, 스레드 정보, 로거 이름, 메시지를 포함한다.
-   **결제 인터페이스 로그**: `payment_interface_request_log` 테이블에 PG사와의 모든 요청 및 응답 전문을 기록하여 결제 실패 시 원인 분석 및 추적을 용이하게 한다.
-   **에러 로깅**: `GlobalExceptionHandler`를 통해 모든 예외는 상세한 스택 트레이스와 함께 로깅되며, `traceId`를 통해 특정 요청의 전체 흐름을 추적할 수 있도록 한다.
-   **모니터링**: 시스템의 주요 지표(CPU 사용률, 메모리 사용량, 네트워크 트래픽, API 응답 시간, 에러율 등)를 실시간으로 모니터링할 수 있는 시스템을 구축해야 한다.

## 4. 에러 처리 및 복구 방식

-   **중앙 집중식 에러 처리**: `@RestControllerAdvice`를 사용하는 `GlobalExceptionHandler`를 통해 모든 API 요청에 대한 예외를 중앙에서 처리한다.
-   **예외 유형별 처리**: `BusinessException`, `PaymentException`, `OrderException` 등 비즈니스 도메인별 예외를 정의하고, 각 예외 유형에 따라 적절한 HTTP 상태 코드와 상세 에러 메시지를 클라이언트에 반환한다.
    -   `400 Bad Request`: 클라이언트 요청 오류 (유효성 검증 실패, 비즈니스 규칙 위반).
    -   `402 Payment Required`: 결제 관련 비즈니스 로직 오류 (PG 승인 실패 등).
    -   `500 Internal Server Error`: 서버 내부 오류 (예상치 못한 예외, DB 오류 등).
-   **망취소 (Net-Cancellation)**: PG사 승인 후 DB 저장 실패와 같은 치명적인 데이터 불일치 상황 발생 시, 자동으로 PG사에 결제 취소를 요청하여 데이터 정합성을 유지하고 사용자 피해를 방지한다.
-   **재시도 메커니즘**: 외부 PG사 API 호출 시 일시적인 네트워크 오류 등에 대비하여 적절한 재시도(Retry) 메커니즘을 고려할 수 있다.
-   **데이터 복구**: 데이터베이스 백업 및 복구 전략을 수립하여 재해 발생 시 데이터 손실을 최소화하고 신속하게 서비스를 복구할 수 있도록 한다.
